# Data Formats and Redis Structures

This document describes the data formats and Redis structures used by the high-throughput repricing system.

## Redis Data Structure Overview

The system uses Redis OM (Object Mapper) to store product data with Pydantic models and comprehensive price validation. All data has a 2-hour TTL (Time To Live).

### Redis OM Integration (2025 Update)

- **JsonModel Architecture**: Replaced SQLAlchemy with Redis OM JsonModel for rich object mapping
- **Pydantic Validation**: Model-level price validation ensures `min_price <= max_price`
- **EmbeddedJsonModel**: Nested B2B tier data with independent validation
- **Seller-First Key Naming**: Autogenerated keys follow `listing:{seller_id}:{asin}` pattern
- **FakeRedis Testing**: Test isolation using fakeredis for reliable testing

### Core Data Organization

```
Redis Key Structure:
├── ASIN_{asin}                          # Product data by ASIN
│   └── {seller_id}:{sku} → JSON         # Individual product listings
├── ASIN_{asin}:{seller_id}              # Alternative structure
│   └── {sku} → JSON                     # SKU-specific data
├── strategy.{strategy_id}               # Strategy configurations
│   └── Hash fields                      # Strategy parameters
├── CALCULATED_PRICES:{seller_id}        # Calculated pricing results
│   └── {sku} → JSON                     # Price calculation data
└── STOCK_{asin}_{seller_id}_{sku}       # Stock quantities (if separate)
    └── String value                     # Current stock count
```

## Redis OM Models (2025 Architecture)

### ProductListing JsonModel
The primary data model using Redis OM with comprehensive validation:

```python
class ProductListing(JsonModel):
    # Product identification - indexed for fast lookups
    asin: str = Field(index=True)
    seller_id: str = Field(index=True) 
    marketplace_type: str = Field(index=True, default="US")
    sku: Optional[str] = Field(index=True, default=None)
    
    # Pricing with validation
    listed_price: Optional[Decimal] = None
    min_price: Optional[Decimal] = None
    max_price: Optional[Decimal] = None
    default_price: Optional[Decimal] = None
    competitor_price: Optional[Decimal] = None
    
    # B2B support
    is_b2b: bool = False
    tiers: Dict[str, B2BTier] = {}
    
    # Strategy results
    updated_price: Optional[Decimal] = None
    message: str = ""
    
    @validator('max_price')
    def validate_price_bounds(cls, v, values):
        min_price = values.get('min_price')
        if v is not None and min_price is not None and v < min_price:
            raise ValueError(f'max_price ({v}) cannot be less than min_price ({min_price})')
        return v
```

### B2BTier EmbeddedJsonModel
Nested model for B2B tier pricing:

```python
class B2BTier(EmbeddedJsonModel):
    # Pricing fields
    competitor_price: Optional[Decimal] = None
    min_price: Optional[Decimal] = None
    max_price: Optional[Decimal] = None
    default_price: Optional[Decimal] = None
    
    # Strategy results
    updated_price: Optional[Decimal] = None
    strategy: Optional[str] = None
    strategy_id: Optional[str] = None
    message: str = ""
    
    @validator('max_price')
    def validate_tier_price_bounds(cls, v, values):
        # Independent validation for each tier
        return v
```

## Product Data Format

### Standard Product Data (Legacy Reference)
```json
{
  "asin": "B07XQXZXYX",
  "sku": "SKU-12345",
  "seller_id": "A1SELLER123",
  "listed_price": 29.99,
  "min": 25.00,
  "max": 45.00,
  "default_price": 30.00,
  "strategy_id": "3",
  "inventory_quantity": 150,
  "inventory_age": 60,
  "status": "Active",
  "item_condition": "new",
  "fulfillment_type": "AMAZON",
  "created_at": "2025-01-15T10:30:00Z",
  "updated_at": "2025-01-15T14:22:00Z"
}
```

### B2B Product Data with Tiers
```json
{
  "asin": "B07XQXZXYX",
  "sku": "SKU-B2B-789",
  "seller_id": "A1SELLER123",
  "listed_price": 29.99,
  "min": 25.00,
  "max": 45.00,
  "default_price": 30.00,
  "strategy_id": "1",
  "inventory_quantity": 500,
  "inventory_age": 30,
  "status": "Active",
  "item_condition": "new",
  "fulfillment_type": "AMAZON",
  "is_b2b": true,
  "b2b_rules": {
    "listed_price": 25.99,
    "min": 20.00,
    "max": 35.00,
    "default_price": 26.00,
    "strategy_id": "2",
    "fulfillment_type": "AMAZON",
    "item_condition": "new",
    "inventory_quantity": 500,
    "tiers": {
      "5": {
        "quantity": 5,
        "listed_price": 24.99,
        "min": 18.00,
        "max": 30.00,
        "default_price": 25.00
      },
      "10": {
        "quantity": 10,
        "listed_price": 22.99,
        "min": 16.00,
        "max": 28.00,
        "default_price": 23.00
      },
      "25": {
        "quantity": 25,
        "listed_price": 20.99,
        "min": 14.00,
        "max": 26.00,
        "default_price": 21.00
      },
      "50": {
        "quantity": 50,
        "listed_price": 18.99,
        "min": 12.00,
        "max": 24.00,
        "default_price": 19.00
      },
      "100": {
        "quantity": 100,
        "listed_price": 16.99,
        "min": 10.00,
        "max": 22.00,
        "default_price": 17.00
      }
    }
  }
}
```

### Field Descriptions

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `asin` | string | ✓ | - | Amazon Standard Identification Number |
| `sku` | string | ✓ | - | Stock Keeping Unit identifier |
| `seller_id` | string | ✓ | - | Amazon seller identifier |
| `listed_price` | float | ✓ | - | Current listed price on marketplace |
| `min` | float | ✓ | - | Minimum allowed price |
| `max` | float | ✓ | - | Maximum allowed price |
| `default_price` | float | ✓ | - | Fallback price when no competitors |
| `strategy_id` | string | ✓ | - | ID of pricing strategy to apply |
| `inventory_quantity` | int | ✗ | null | Available stock quantity |
| `inventory_age` | int | ✗ | 0 | Age of inventory in days |
| `status` | string | ✗ | "Active" | Product status (Active/Inactive) |
| `item_condition` | string | ✗ | "new" | Product condition |
| `fulfillment_type` | string | ✗ | "AMAZON" | Fulfillment method |
| `is_b2b` | boolean | ✗ | false | Whether product has B2B pricing |

## Strategy Configuration Format

### Basic Strategy
```json
{
  "strategy_id": "1",
  "compete_with": "MATCH_BUYBOX",
  "beat_by": -0.10,
  "min_price_rule": "JUMP_TO_MIN",
  "max_price_rule": "JUMP_TO_MAX",
  "b2b_compete_for": "LOW",
  "b2b_beat_by_rule": "BEAT_BY"
}
```

### Strategy with Inventory Age Rules
```json
{
  "strategy_id": "5",
  "compete_with": "MATCH_BUYBOX",
  "beat_by": -0.05,
  "min_price_rule": "MATCH_COMPETITOR",
  "max_price_rule": "JUMP_TO_MAX",
  "inventory_age_threshold": 90,
  "inventory_age_rules": {
    "0-90": {
      "strategy_id": "1"
    },
    "91-180": {
      "strategy_id": "2"
    },
    "181-270": {
      "strategy_id": "3"
    },
    "271-365": {
      "strategy_id": "4"
    },
    "365+": {
      "strategy_id": "6"
    }
  }
}
```

### Strategy Field Descriptions

| Field | Type | Default | Options | Description |
|-------|------|---------|---------|-------------|
| `compete_with` | string | "MATCH_BUYBOX" | MATCH_BUYBOX, LOWEST_PRICE, LOWEST_FBA_PRICE | Competition target |
| `beat_by` | float | 0.0 | any | Amount to beat competitor by (negative = undercut) |
| `min_price_rule` | string | "JUMP_TO_MIN" | JUMP_TO_MIN, MATCH_COMPETITOR, DEFAULT_PRICE, SKIP | Action when below min price |
| `max_price_rule` | string | "JUMP_TO_MAX" | JUMP_TO_MAX, MATCH_COMPETITOR, DEFAULT_PRICE, SKIP | Action when above max price |
| `b2b_compete_for` | string | "LOW" | LOW, HIGH | B2B competition strategy |
| `b2b_beat_by_rule` | string | "BEAT_BY" | BEAT_BY, PERCENTAGE | How to apply beat_by in B2B |

## Calculated Price Data Format

### Price Calculation Result
```json
{
  "asin": "B07XQXZXYX",
  "seller_id": "A1SELLER123",
  "sku": "SKU-12345",
  "old_price": 29.99,
  "new_price": 28.50,
  "strategy_used": "WIN_BUYBOX",
  "strategy_id": "3",
  "competitor_price": 28.99,
  "calculated_at": "2025-01-15T14:30:00Z",
  "saved_at": "2025-01-15T14:30:01Z",
  "expires_at": "2025-01-15T16:30:01Z",
  "processing_time_ms": 45.2,
  "tier_prices": {
    "5": 26.50,
    "10": 24.50,
    "25": 22.50,
    "50": 20.50,
    "100": 18.50
  }
}
```

## Message Formats

### Amazon SQS ANY_OFFER_CHANGED Notification

#### Raw SQS Message Structure
```json
{
  "Type": "Notification",
  "MessageId": "12345678-1234-1234-1234-123456789012",
  "TopicArn": "arn:aws:sns:us-east-1:123456789012:any-offer-changed",
  "Subject": "Amazon MWS Notification",
  "Message": "{...}",  // JSON string containing the actual notification
  "Timestamp": "2025-01-15T14:30:00.000Z",
  "SignatureVersion": "1",
  "Signature": "...",
  "UnsubscribeURL": "..."
}
```

#### Parsed Notification Content (inside Message field)
```json
{
  "notificationType": "AnyOfferChanged",
  "payloadVersion": "1.0",
  "eventTime": "2025-01-15T14:30:00.000Z",
  "payload": {
    "anyOfferChangedNotification": {
      "sellerId": "A1SELLER123",
      "asin": "B07XQXZXYX",
      "marketplaceId": "ATVPDKIKX0DER",
      "itemCondition": "NEW",
      "timeOfOfferChange": "2025-01-15T14:30:00.000Z"
    }
  }
}
```

### Walmart Webhook Payload

#### Buy Box Changed Notification
```json
{
  "eventType": "buybox_changed",
  "webhookId": "wh_12345",
  "timestamp": "2025-01-15T14:30:00.000Z",
  "itemId": "12345678901",
  "sellerId": "WM_SELLER_123",
  "marketplace": "US",
  "eventTime": "2025-01-15T14:30:00.000Z",
  "currentBuyboxPrice": 28.99,
  "currentBuyboxWinner": "WM_COMPETITOR_456",
  "offers": [
    {
      "sellerId": "WM_SELLER_123",
      "price": 29.99,
      "shipping": 0.00,
      "condition": "NEW",
      "fulfillmentType": "WALMART"
    },
    {
      "sellerId": "WM_COMPETITOR_456", 
      "price": 28.99,
      "shipping": 0.00,
      "condition": "NEW",
      "fulfillmentType": "WALMART"
    }
  ]
}
```

### Processed Offer Data (Internal Format)

#### Normalized Message for Pipeline Processing
```json
{
  "product_id": "B07XQXZXYX",  // ASIN for Amazon, item_id for Walmart
  "seller_id": "A1SELLER123",
  "marketplace": "US",
  "platform": "AMAZON",  // or "WALMART"
  "event_time": "2025-01-15T14:30:00.000Z",
  "processed_time": "2025-01-15T14:30:01.234Z",
  "item_condition": "NEW",
  "competitor_price": 28.99,
  "buybox_winner": "A2COMPETITOR456",
  "total_offers": 5,
  "raw_offers": [...],  // Original offer data for detailed analysis
  "raw_summary": {...}  // Original summary data
}
```

## Redis Key Examples

### Product Data Keys
```
ASIN_B07XQXZXYX → Hash
  ├── A1SELLER123:SKU-12345 → JSON product data
  ├── A1SELLER123:SKU-67890 → JSON product data
  └── A2SELLER456:SKU-ABCDE → JSON product data

Alternative structure:
ASIN_B07XQXZXYX:A1SELLER123 → Hash
  ├── SKU-12345 → JSON product data
  └── SKU-67890 → JSON product data
```

### Strategy Keys
```
strategy.1 → Hash
  ├── compete_with → "MATCH_BUYBOX"
  ├── beat_by → "-0.10"
  ├── min_price_rule → "JUMP_TO_MIN"
  └── max_price_rule → "JUMP_TO_MAX"

strategy.5 → Hash  
  ├── compete_with → "MATCH_BUYBOX"
  ├── beat_by → "-0.05"
  ├── inventory_age_rules → JSON string
  └── inventory_age_threshold → "90"
```

### Calculated Price Keys
```
CALCULATED_PRICES:A1SELLER123 → Hash
  ├── SKU-12345 → JSON calculated price data
  ├── SKU-67890 → JSON calculated price data
  └── SKU-ABCDE → JSON calculated price data
```

## Data Flow Processing

### Step 1: Message Processing
Raw webhook/SQS message → ProcessedOfferData schema validation → Essential field extraction

### Step 2: Data Retrieval  
ProcessedOfferData → Redis lookup for product data and strategy → Product/Strategy objects

### Step 3: Repricing Decision
Product data + Strategy + Competition info → Business logic evaluation → RepricingDecision

### Step 4: Price Calculation
RepricingDecision → Strategy application → Price calculation → CalculatedPrice

### Step 5: Persistence
CalculatedPrice → Redis storage (if price changed) → 2-hour TTL

## Performance Considerations

### Redis Optimization
- Use Redis pipelining for bulk operations
- Set appropriate TTL (2 hours) on all keys
- Use Redis connection pooling (max 20 connections)
- Implement Redis cluster for horizontal scaling

### Data Size Limits
- Individual JSON documents: < 1MB recommended
- Batch sizes: 100-1000 items for bulk operations
- Message payload size: < 256KB for SQS/webhooks

### Caching Strategy
- Product data cached for 2 hours
- Strategy data cached for 2 hours  
- Calculated prices cached for 2 hours
- Use Redis EXPIRE for automatic cleanup

## Error Handling Data Formats

### Error Information
```json
{
  "error_id": "err_1705409400_abc12345",
  "error_type": "ValidationError",
  "message": "Missing required field: asin",
  "category": "validation",
  "severity": "medium",
  "context": {
    "message_type": "amazon",
    "message_id": "msg_123",
    "processing_step": "message_validation"
  },
  "retry_count": 1,
  "max_retries": 3,
  "timestamp": "2025-01-15T14:30:00.000Z",
  "exception_type": "KeyError"
}
```

### Dead Letter Queue Message
```json
{
  "original_message": {...},  // Original failed message
  "error_info": {...},        // Error information from above
  "failed_at": "2025-01-15T14:30:00.000Z",
  "queue_type": "amazon",
  "retry_attempts": 3
}
```

## Monitoring and Metrics Data

### Processing Statistics
```json
{
  "messages_processed": 15420,
  "successful_repricings": 14890,
  "failed_repricings": 530,
  "prices_updated": 8945,
  "average_processing_time_ms": 125.4,
  "success_rate": 96.56,
  "uptime_seconds": 7200,
  "messages_per_second": 2.14,
  "timestamp": "2025-01-15T14:30:00.000Z"
}
```

### Health Check Response
```json
{
  "overall_status": "healthy",
  "orchestrator": "healthy",
  "redis": true,
  "message_processor": "healthy", 
  "repricing_engine": "healthy",
  "average_processing_time_ms": 125.4,
  "stats": {...},
  "timestamp": "2025-01-15T14:30:00.000Z"
}
```